  <!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GibSorgu â€¢ Ã‡oklu Servis JOIN Sorgu AracÄ±</title>
<style>
:root{
  --bg:#0e1116;--card:#171b22;--mut:#9aa6bf;--ink:#eaf0ff;
  --acc:#6ea8fe;--ok:#3ccf91;--err:#ff6b6b;--line:#232a36;
  --tbl:#283142;--thead:#1e2633;--input:#0d1117;
}
html,body{
  background:var(--bg);color:var(--ink);
  font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto;
}
.wrap{max-width:1200px;margin:32px auto 22px;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);
  border-radius:12px;padding:14px;margin-top:12px}
h1{margin:0 0 8px;font-size:20px}
label{display:block;color:var(--mut);margin:6px 0 3px}
input,textarea,select{
  width:100%;background:var(--input);color:var(--ink);
  border:1px solid #2a3342;border-radius:8px;padding:7px 9px
}
textarea{min-height:70px;white-space:pre}
small{color:var(--mut)}
.grid{display:grid;gap:10px}
.g2{grid-template-columns:1fr 1fr}
.g3{grid-template-columns:1fr 1fr 1fr}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{
  background:var(--acc);border:0;color:#081018;
  padding:7px 11px;border-radius:8px;font-weight:700;cursor:pointer;
}
button:disabled{opacity:.4;cursor:not-allowed}
.ok{background:var(--ok)!important;color:#00150b}
.err{color:var(--err)}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--tbl);padding:6px 8px;text-align:left;vertical-align:top}
th{background:var(--thead);position:sticky;top:0;z-index:1}
.progress-wrap{margin-top:8px}
.progress-bar{width:100%;height:10px;border-radius:5px;overflow:hidden;background:var(--thead)}
.progress-inner{height:100%;width:0;background:linear-gradient(90deg,var(--ok),var(--acc));transition:width .2s}
.progress-text{text-align:right;font-size:12px;color:#9aa6bf;margin-top:3px}
fieldset{border:1px solid #2a3342;border-radius:10px;padding:8px}
legend{color:#99b6ff;padding:0 6px}
.service-card{border:1px solid #2a3342;border-radius:10px;padding:8px;margin-top:8px}
.service-header{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.service-header span{font-weight:600}
.service-extra{margin-top:4px;font-size:12px;color:#9aa6bf}
.badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;background:#283142;color:#dfe7ff}
</style>
</head>
<body>

<!-- Sabit versiyon etiketi -->
<div style="
  position:fixed;
  top:6px;
  right:10px;
  padding:3px 8px;
  border-radius:999px;
  background:#171b22;
  border:1px solid #232a36;
  font-size:11px;
  color:#9aa6bf;
  z-index:9999;
">
  GibSorgu v1.0
</div>

<div class="wrap">
<h1>GibSorgu â€¢ Ã‡oklu Servis JOIN Sorgu AracÄ±</h1>

<!-- GENEL BAÄLANTI + LÄ°STE -->
<div class="card">
  <div class="grid g3">
    <div>
      <label>Token / URL</label>
      <input id="token" class="mono" placeholder="...token=...">
    </div>
    <div>
      <label>JSESSIONID (opsiyonel)</label>
      <input id="cookie" class="mono" placeholder="JSESSIONID=...">
    </div>
    <div>
      <label>Kimlik TÃ¼rÃ¼ (Liste)</label>
      <select id="idType">
        <option value="vkn">VKN</option>
        <option value="tckn">TCKN</option>
      </select>
      <small>Listeye ne yazÄ±yorsan (VKN/TCKN/Vergi No), <b>[ID]</b> yer tutucusuna o gider.</small>
    </div>
  </div>

  <div class="grid g3" style="margin-top:8px">
    <div>
      <label>ID ArasÄ± Bekleme (ms)</label>
      <input id="delayMs" class="mono" value="500">
      <small>0 = bekleme yok, 500 = 0.5 sn, 1000 = 1 sn</small>
    </div>
    <div>
      <label>Otomatik hÄ±z ayarÄ±</label>
      <div class="row">
        <input type="checkbox" id="autoDelay" style="width:auto">
        <small>Hata aldÄ±kÃ§a yavaÅŸlar, sorunsuz giderse hÄ±zlanÄ±r (min: taban bekleme)</small>
      </div>
    </div>
    <div>
      <label>Ã–n Ä°zlemede Taranacak ID SayÄ±sÄ±</label>
      <input id="previewCount" class="mono" value="10">
      <small>AlanlarÄ± Ã§Ä±karmak iÃ§in kaÃ§ IDâ€™yi denesin (Ã¶rn: 5, 10, 30...)</small>
    </div>
  </div>

  <div class="grid g2" style="margin-top:8px">
    <div>
      <label>Kimlik Listesi (VKN/TCKN/Vergi No)</label>
      <textarea id="ids" class="mono" placeholder="Her satÄ±ra bir ID"></textarea>
    </div>
    <div>
      <label>JOIN Kimlik SÃ¼tun BaÅŸlÄ±ÄŸÄ±</label>
      <input id="idColName" class="mono" value="Vergi No">
      <small>Tablodaki ilk sÃ¼tunun adÄ± (Ã¶rn. Vergi No, VKN/TCKN).</small>
      <label style="margin-top:8px">JOIN Kimlik JSON Path (opsiyonel)</label>
      <input id="idPath" class="mono" placeholder="Ã¶r: data.vkn; boÅŸsa listeden gelen ID kullanÄ±lÄ±r">
      <small>BoÅŸsa KEY = listedeki ID olur. Doluysa, servis yanÄ±tÄ±nda bu pathâ€™ten ilk dolu bulunan deÄŸer kullanÄ±lÄ±r.</small>
    </div>
  </div>

  <div class="row" style="margin-top:8px">
    <button id="btnInit" class="ok">1) Ã–n Ä°zleme / AlanlarÄ± Ã‡Ä±kar</button>
    <button id="btnRun">2) TÃ¼m Listeyi Ã‡alÄ±ÅŸtÄ±r & JOIN</button>
    <button id="btnStop" disabled>â¹ Durdur & Kaydet</button>
    <button id="btnResume">â–¶ Devam (kaldÄ±ÄŸÄ± yerden)</button>
    <button id="btnCSV" disabled>CSV Ä°ndir</button>
  </div>

  <div class="row" style="margin-top:6px">
    <button id="btnAddService">â• Servis Ekle</button>

    <button id="btnSaveTpl">ğŸ’¾ Genel Åablon Kaydet</button>
    <select id="selTpl">
      <option value="">Genel ÅŸablon...</option>
    </select>
    <button id="btnDelTpl">ğŸ—‘ï¸ Sil</button>
    <button id="btnExportTpl">â¬‡ï¸ DÄ±ÅŸa Aktar</button>
    <input type="file" id="tplImport" style="display:none" accept=".json">
    <button id="btnImportTpl">â¬†ï¸ Ä°Ã§e Aktar</button>

    <span id="stat" class="mono" style="margin-left:auto;color:#9aa6bf"></span>
  </div>

  <div class="progress-wrap">
    <div class="progress-bar"><div class="progress-inner" id="bar"></div></div>
    <div class="progress-text" id="barText">HazÄ±r</div>
  </div>
</div>

<!-- SERVÄ°SLER -->
<div class="card">
  <fieldset>
    <legend>Servis TanÄ±mlarÄ±</legend>

    <!-- Servis ÅŸablonu barÄ± -->
    <div class="row" style="margin-bottom:6px">
      <span id="svcActiveLabel" class="mono">Aktif servis: (kartÄ±n Ã¼zerine tÄ±kla)</span>
      <button id="btnSaveSvcTpl">ğŸ’¾ Bu servisi ÅŸablon olarak kaydet</button>
      <select id="selSvcTpl">
        <option value="">Servis ÅŸablonu...</option>
      </select>
      <button id="btnLoadSvcTpl">â¬†ï¸ Aktif servise yÃ¼kle</button>
      <button id="btnDelSvcTpl">ğŸ—‘ï¸ Sil</button>
    </div>

    <div id="services"></div>
    <small>
      JP ÅŸablonu iÃ§inde kullanabileceÄŸin yer tutucular: <b>[ID]</b> + istediÄŸin ekler:
      <b>[TCKN]</b>, <b>[VDKODU]</b>, <b>[ILKODU]</b>, <b>[DURUM]</b>, <b>[LISTNAME]</b> vb.<br>
      <b>[ID]</b> â†’ listeden gelen kimlik (VKN/TCKN/Vergi No), bunun iÃ§in kutu aÃ§Ä±lmaz.<br>
      DiÄŸer tÃ¼m kÃ¶ÅŸeli alanlar iÃ§in altÄ±nda otomatik input aÃ§Ä±lÄ±r ve her sorguda valueâ€™ya yazÄ±lÄ±r.<br>
      <b>Ã‡oklu kayÄ±t modu</b> = aynÄ± servisten gelen <code>data0, data1, data2...</code> kayÄ±tlarÄ±nÄ±n tek ID iÃ§in alt alta yazÄ±lmasÄ±.<br>
      <b>ArÅŸiv Sorgu</b> tiki iÅŸaretli servislerden kayÄ±t gelirse satÄ±rdaki "KayÄ±t TÃ¼rÃ¼" = ArÅŸiv, aksi halde GÃ¼ncel yazÄ±lÄ±r.
    </small>
  </fieldset>
</div>

<!-- Alan SeÃ§imi -->
<div class="card">
  <fieldset>
    <legend>Alan SeÃ§imi (Servis BazlÄ±)</legend>
    <label>Alan Ara / Filtrele</label>
    <input id="fieldSearch" class="mono" placeholder="Ã¶rn: unvan, durum, tarih...">
    <small>YazdÄ±kÃ§a aÅŸaÄŸÄ±daki alan listesi filtrelenir.</small>
    <div id="fieldsAll" style="font-size:13px;color:#9aa6bf;margin-top:8px">
      â€” Ã–nce â€œÃ–n Ä°zleme / AlanlarÄ± Ã‡Ä±karâ€ butonuna bas â€”
    </div>
  </fieldset>
</div>

<!-- Excel SÃ¼tun Tipleri + BaÅŸlÄ±klar -->
<div class="card">
  <fieldset>
    <legend>Excel SÃ¼tun Tipleri ve BaÅŸlÄ±klarÄ±</legend>
    <div id="excelBox" style="font-size:13px;color:#9aa6bf">
      â€” AlanlarÄ± seÃ§tikten sonra burada her sÃ¼tun iÃ§in baÅŸlÄ±k + tip belirleyebilirsin â€”
    </div>
  </fieldset>
</div>

<!-- Tablo -->
<div class="card">
  <table id="tbl">
    <thead id="thead"><tr><th>Kimlik</th><th>KayÄ±t TÃ¼rÃ¼</th><th>Servis Bilgisi</th></tr></thead>
    <tbody id="tbody"><tr><td colspan="3" style="color:#9aa6bf">HenÃ¼z veri yok</td></tr></tbody>
  </table>
</div>

</div> <!-- wrap -->

<script>
const $ = s => document.querySelector(s);
const TPL_KEY = 'gibMultiServisTemplates';
const RUN_KEY = 'gibMultiServisLastRun';
const SVC_TPL_KEY = 'gibServiceDefs';

function parseToken(s){
  if(!s) return '';
  const m = /(?:^|[?&])token=([^&]+)/.exec(s);
  return m ? decodeURIComponent(m[1]) : s.trim();
}
function callid(){ return String(Date.now())+Math.floor(Math.random()*1000); }
function get(o,p){
  if(!p) return o;
  const r=/(\w+)|\[(\d+)\]/g;let c=o,m;
  while((m=r.exec(p))){
    const k=m[1]!==undefined?m[1]:Number(m[2]);
    if(c==null) return '';
    c=c[k];
  }
  return c==null?'':c;
}
function ensureArray(x){ return Array.isArray(x)?x:(x==null?[]:[x]); }
function csvRow(a){
  return a.map(s=>{
    s=String(s??'');
    return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s;
  }).join(',');
}
function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }
function collectKeys(obj,prefix='',depth=2,out=new Set()){
  if(obj==null||typeof obj!=='object') return out;
  if(Array.isArray(obj)){
    if(obj.length) collectKeys(obj[0],prefix+'[0]',depth,out);
    return out;
  }
  for(const k of Object.keys(obj)){
    const val=obj[k];
    const path=prefix?(prefix+'.'+k):k;
    if(val!=null && typeof val==='object' && depth>0)
      collectKeys(val,path,depth-1,out);
    else
      out.add(path);
  }
  return out;
}
function updateBar(done,total,extraText){
  const pct=Math.floor((done/Math.max(total,1))*100);
  $('#bar').style.width=pct+'%';
  $('#barText').textContent=`${done}/${total} (%${pct})` + (extraText?(' â€¢ '+extraText):'');
}

/* Alan filtreleme (arama kutusu) */
function applyFieldFilter(){
  const box = $('#fieldsAll');
  const qEl = $('#fieldSearch');
  if(!box || !qEl) return;
  const q = qEl.value.trim().toLowerCase();
  const labels = box.querySelectorAll('label');
  labels.forEach(l=>{
    if(!q){
      l.style.display='block';
      return;
    }
    const txt = l.textContent.toLowerCase();
    l.style.display = txt.includes(q) ? 'block' : 'none';
  });
}

/* === SERVÄ°S YÃ–NETÄ°MÄ° === */
let services = [];
let serviceCounter = 0;
let ids = [];
let rowsOut = [];
let currentHeaders = [];
let runStop = false;
let activeService = null;

// otomatik hÄ±z
let dynamicDelay = 0;
let successStreak = 0;
let errorStreak = 0;

function rebuildExtraFields(svc){
  const box = svc.extraBox;
  box.innerHTML='';
  const tpl = svc.tplEl.value || '';
  const re=/\[([A-Z0-9_]+)]/gi;
  const seen=new Set();
  let m;
  while((m=re.exec(tpl))){
    const key = m[1];
    const up = key.toUpperCase();
    // Sadece [ID] sabit, onun iÃ§in kutu aÃ§mÄ±yoruz
    if(up==='ID') continue;
    if(seen.has(up)) continue;
    seen.add(up);
  }
  svc.extraDefs = [];
  if(!seen.size){
    box.innerHTML='<small style="color:#666">Ek yer tutucu yok (sadece [ID] kullanÄ±lÄ±yor).</small>';
    return;
  }
  seen.forEach(k=>{
    const wrap=document.createElement('div');
    wrap.innerHTML=`
      <label>${k} deÄŸeri</label>
      <input class="mono" placeholder="${k} iÃ§in deÄŸer (Ã¶r: 2050, 16, vdKodu...)">
    `;
    const input = wrap.querySelector('input');
    box.appendChild(wrap);
    svc.extraDefs.push({key:k.toUpperCase(), input});
  });
}

function setActiveServiceLabel(svc){
  const lbl = $('#svcActiveLabel');
  if(!lbl) return;
  if(!svc){
    lbl.textContent='Aktif servis: (kartÄ±n Ã¼zerine tÄ±kla)';
  }else{
    lbl.textContent='Aktif servis: ' + (svc.nameEl.value || ('Servis '+svc.id));
  }
}

function addService(config={}){
  const id = ++serviceCounter;
  const isBase = !!config.base;
  const wrap=document.createElement('div');
  wrap.className='service-card';
  wrap.dataset.sid=id;

  const name = config.name || (isBase? 'Servis 1 (Sabit)':'Servis '+id);

  wrap.innerHTML=`
    <div class="service-header">
      <input type="checkbox" class="svc-enable"${isBase?' checked disabled':''}>
      <span>${name}</span>
      ${isBase?'<span class="badge">Sabit</span>':'<span class="badge">Ek Servis</span>'}
    </div>
    <div class="grid g3">
      <div>
        <label>Servis AdÄ±</label>
        <input class="svc-name mono" value="${name}">
        <label style="margin-top:4px;font-size:12px">
          <input type="checkbox" class="svc-archive" style="width:auto"> ArÅŸiv Sorgu
        </label>
      </div>
      <div>
        <label>Dispatch</label>
        <input class="svc-dispatch mono" placeholder="http://.../dispatch" value="${config.dispatch||''}">
      </div>
      <div>
        <label>cmd</label>
        <input class="svc-cmd mono" placeholder="Ã¶r: ozesService_getir" value="${config.cmd||''}">
      </div>
    </div>
    <div class="grid g2" style="margin-top:6px">
      <div>
        <label>KayÄ±t Dizisi Path</label>
        <input class="svc-array mono" placeholder="Ã¶r: data.liste" value="${config.arrayPath||''}">
        <small>BoÅŸsa JSON iÃ§inde ilk dizi otomatik bulunmaya Ã§alÄ±ÅŸÄ±lÄ±r.</small>
        <label style="margin-top:6px">Ã‡oklu KayÄ±t Modu</label>
        <select class="svc-multi mono">
          <option value="first">Ä°lk kayÄ±t</option>
          <option value="all">TÃ¼m kayÄ±tlar (alt alta)</option>
        </select>
      </div>
      <div>
        <label>JP Åablonu</label>
        <textarea class="svc-tpl mono" placeholder='{"mukVkn":"[ID]","durum":"[DURUM]"}'>${config.tpl||''}</textarea>
        <small>Yer tutucular: [ID] + ek alanlar (Ã¶rn: [TCKN], [VDKODU], [ILKODU], [DURUM], [LISTNAME]).</small>
      </div>
    </div>
    <div class="service-extra">
      <b>Ek Alanlar (Yer Tutucular iÃ§in DeÄŸerler)</b>
      <div class="svc-extra-box"></div>
    </div>
  `;

  $('#services').appendChild(wrap);

  const svc = {
    id,
    base:isBase,
    el:wrap,
    enabledEl:wrap.querySelector('.svc-enable'),
    nameEl:wrap.querySelector('.svc-name'),
    dispatchEl:wrap.querySelector('.svc-dispatch'),
    cmdEl:wrap.querySelector('.svc-cmd'),
    arrayPathEl:wrap.querySelector('.svc-array'),
    tplEl:wrap.querySelector('.svc-tpl'),
    multiEl:wrap.querySelector('.svc-multi'),
    archiveEl:wrap.querySelector('.svc-archive'),
    extraBox:wrap.querySelector('.svc-extra-box'),
    extraDefs:[],
    fields:[],
    selectedFields:[]
  };

  if(config.multiMode){
    svc.multiEl.value = config.multiMode;
  }
  if(typeof config.archive === 'boolean' && svc.archiveEl){
    svc.archiveEl.checked = config.archive;
  }

  svc.tplEl.addEventListener('input',()=>rebuildExtraFields(svc));
  rebuildExtraFields(svc);

  svc.el.addEventListener('click',()=>{
    activeService = svc;
    setActiveServiceLabel(svc);
  });
  svc.nameEl.addEventListener('input',()=>{
    if(activeService===svc) setActiveServiceLabel(svc);
  });

  services.push(svc);

  if(config.extras){
    svc.extraDefs.forEach(d=>{
      if(config.extras[d.key] !== undefined){
        d.input.value = config.extras[d.key];
      }
    });
  }
  if(!isBase && typeof config.enabled === 'boolean'){
    svc.enabledEl.checked = config.enabled;
  }
  return svc;
}

function clearServices(){
  services.forEach(s=>s.el.remove());
  services = [];
  serviceCounter = 0;
  activeService = null;
  setActiveServiceLabel(null);
}

function initDefaultServices(){
  // Ã–rnek defaultâ€™lar: bunlarÄ± kendi servislerine gÃ¶re dÃ¼zenleyebilirsin
  addService({
    base:true,
    name:'Servis 1 (Sicil / Temel)',
    tpl:'{"vkn":"[ID]","tckn":"[TCKN]","vdKodu":"[VDKODU]","ilKodu":"[ILKODU]"}',
    arrayPath:'',
    multiMode:'first',
    archive:false
  });
  addService({
    base:false,
    name:'Servis 2 (Ã–zel Esas vb.)',
    tpl:'{"mukVkn":"[ID]","mukTckn":"[TCKN]","durum":"[DURUM]","listName":"[LISTNAME]"}',
    arrayPath:'',
    multiMode:'all',
    archive:true
  });
}

/* HTTP */
async function postOnce(dispatch,tokenInput,cmd,jpObj){
  const token=parseToken(tokenInput);
  const body=new URLSearchParams();
  body.set('cmd',cmd);
  body.set('callid',callid());
  body.set('token',token);
  body.set('jp',JSON.stringify(jpObj));
  const res=await fetch(dispatch,{
    method:'POST',
    headers:{
      'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8',
      'Accept':'application/json, text/javascript, */*; q=0.01'
    },
    credentials:'include',
    body
  });
  const txt=await res.text();
  try{ return {ok:true,json:JSON.parse(txt)}; }
  catch{ return {ok:false,raw:txt,status:res.status}; }
}

/* Tek servis Ã§aÄŸÄ±rÄ±cÄ± â†’ tÃ¼m kayÄ±t dizisini dÃ¶ner */
async function fetchServiceRecords(id, common, svc){
  const dispatch = svc.dispatchEl.value.trim();
  const cmd = svc.cmdEl.value.trim();
  if(!dispatch || !cmd) return {error:true,msg:'dispatch/cmd eksik', arr:[], empty:true};

  const tplRaw = (svc.tplEl.value||'').trim();
  const idVal = String(id);
  let jp;

  if(tplRaw){
    // Sadece [ID] Ã¶zel: liste kimliÄŸi
    let text = tplRaw.replace(/\[ID]/gi, idVal);

    // DiÄŸer tÃ¼m [PLACEHOLDER]â€™lar iÃ§in kutulardaki deÄŸerleri yaz
    (svc.extraDefs||[]).forEach(def=>{
      const val = (def.input.value||'').trim();
      const re = new RegExp('\\['+def.key+']','gi');
      text = text.replace(re,val);
    });

    try{
      jp = JSON.parse(text);
    }catch(e){
      return {error:true,msg:'JP JSON parse hata: '+e.message,arr:[],empty:true};
    }
  }else{
    // hiÃ§ ÅŸablon yoksa basit fallback
    const key = (common.idType==='tckn'?'tckn':'vkn');
    jp={}; jp[key]=idVal;
  }

  const r = await postOnce(dispatch, common.token, cmd, jp);
  if(!r.ok) return {error:true,msg:'HTTP/JSON hata: '+(r.status||''),arr:[],empty:true};

  let arr;
  const path = svc.arrayPathEl.value.trim();
  if(path){
    arr = ensureArray(get(r.json,path));
  }else{
    const d = r.json.data ?? r.json;
    let found=null;
    (function walk(o,p){
      if(found) return;
      if(Array.isArray(o)){found=p||'';return;}
      if(o && typeof o==='object'){
        for(const k of Object.keys(o)){
          walk(o[k], p?`${p}.${k}`:k);
          if(found) return;
        }
      }
    })(d,'');
    arr = found ? ensureArray(get(r.json,found)) : ensureArray(d);
  }
  return {error:false,arr,empty:!arr.length};
}

/* Alan seÃ§imi paneli */
function renderFieldSelection(){
  const box = $('#fieldsAll');
  box.innerHTML='';
  services.forEach(svc=>{
    if(!svc.base && !svc.enabledEl.checked) return;
    const fields = svc.fields||[];
    const svcId = svc.id;
    const title = (svc.nameEl.value||'Servis '+svcId);
    const section=document.createElement('div');
    section.style.marginBottom='8px';
    section.innerHTML=`<div style="margin-bottom:4px"><b>${title}</b></div>`;
    if(!fields.length){
      section.innerHTML+='<span class="err">Alan bulunamadÄ±.</span>';
      box.appendChild(section);
      return;
    }
    section.innerHTML+=fields.map(f=>`
      <label style="display:block">
        <input type="checkbox" class="fld" data-sid="${svcId}" value="${f}"> ${f}
      </label>
    `).join('');
    box.appendChild(section);
  });
  if(!box.innerHTML.trim()){
    box.textContent='â€” Etkin servis yok veya alan bulunamadÄ± â€”';
  }
  applyFieldFilter();
}

/* Excel paneli */
function renderExcelBox(headers){
  const box=$('#excelBox');
  if(!headers.length){
    box.innerHTML='â€” Ã–nce alanlarÄ± seÃ§, sonra burada ayar yap â€”';return;
  }
  let html='';
  headers.forEach((h,i)=>{
    html+=`
      <div class="mono" style="margin-bottom:8px;border-bottom:1px dashed #2a3342;padding-bottom:4px">
        <b>${h}</b><br>
        Dahil et:
        <input type="checkbox" class="exInclude" data-col="${h}" checked>
        SÄ±ra:
        <input class="exOrder" data-col="${h}" type="number" value="${i+1}" style="width:60px;margin:0 6px">
        <br>
        BaÅŸlÄ±k:
        <input class="exLabel" data-col="${h}" value="${h}" style="width:180px;margin:4px 6px 0 0">
        TÃ¼r:
        <select class="exType" data-col="${h}">
          <option value="auto">Otomatik</option>
          <option value="text">Metin</option>
          <option value="number">SayÄ±</option>
          <option value="date">Tarih</option>
        </select>
      </div>
    `;
  });
  box.innerHTML=html;
  const first=headers[0];
  const s=document.querySelector('.exType[data-col="'+first+'"]');
  if(s) s.value='text';
}
function getColumnConfig(){
  const cfg = {};
  currentHeaders.forEach((h,idx)=>{
    cfg[h]={name:h,index:idx,include:true,order:idx+1,type:'auto',label:h};
  });
  document.querySelectorAll('.exInclude').forEach(cb=>{
    const col=cb.dataset.col;
    if(cfg[col]) cfg[col].include = cb.checked;
  });
  document.querySelectorAll('.exOrder').forEach(inp=>{
    const col=inp.dataset.col;
    const v=parseInt(inp.value,10);
    if(cfg[col]) cfg[col].order = isNaN(v)?(cfg[col].index+1):v;
  });
  document.querySelectorAll('.exType').forEach(sel=>{
    const col=sel.dataset.col;
    if(cfg[col]) cfg[col].type = sel.value||'auto';
  });
  document.querySelectorAll('.exLabel').forEach(inp=>{
    const col=inp.dataset.col;
    if(cfg[col]) cfg[col].label = inp.value.trim() || col;
  });
  return cfg;
}

/* Tablo */
function writeHeader(){
  const idLabel = ($('#idColName').value.trim() || 'Kimlik');
  const headers = [idLabel,'KayÄ±t TÃ¼rÃ¼'];
  services.forEach(svc=>{
    if(!svc.base && !svc.enabledEl.checked) return;
    const prefix = (svc.nameEl.value||('Servis '+svc.id));
    (svc.selectedFields||[]).forEach(f=>{
      headers.push(prefix+':'+f);
    });
  });
  currentHeaders = headers.slice();
  $('#thead').innerHTML='<tr>'+headers.map(h=>'<th>'+h+'</th>').join('')+'</tr>';
  renderExcelBox(headers);
}
function paintRows(){
  const tb = $('#tbody');
  if(!rowsOut.length){
    tb.innerHTML='<tr><td colspan="3" style="color:#9aa6bf">HenÃ¼z veri yok</td></tr>';
    return;
  }
  tb.innerHTML = rowsOut.map(r=>'<tr>'+r.map(v=>{
    const txt=v==null?'':String(v);
    const isErr=txt.startsWith('âŒ');
    return `<td style="${isErr?'color:#ff6b6b':''}">${txt.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</td>`;
  }).join('')+'</tr>').join('');
}

/* GENEL ÅABLON SÄ°STEMÄ° */
function currentTemplateObject(){
  return{
    token:$('#token').value.trim(),
    cookie:$('#cookie').value.trim(),
    idType:$('#idType').value,
    idColName:$('#idColName').value.trim(),
    idPath:$('#idPath').value.trim(),
    delayBase: parseInt($('#delayMs').value,10) || 0,
    autoDelay: $('#autoDelay').checked,
    previewCount: parseInt($('#previewCount').value,10) || 10,
    services: services.map(svc=>{
      const extras={};
      (svc.extraDefs||[]).forEach(d=>{
        extras[d.key]=d.input.value;
      });
      return{
        base:svc.base,
        name:svc.nameEl.value,
        dispatch:svc.dispatchEl.value,
        cmd:svc.cmdEl.value,
        arrayPath:svc.arrayPathEl.value,
        tpl:svc.tplEl.value,
        enabled:svc.base ? true : svc.enabledEl.checked,
        multiMode:svc.multiEl.value,
        archive: svc.archiveEl ? svc.archiveEl.checked : false,
        extras
      };
    })
  };
}
function loadTemplates(){
  const all=JSON.parse(localStorage.getItem(TPL_KEY)||'{}');
  const sel=$('#selTpl');
  sel.innerHTML='<option value="">Genel ÅŸablon...</option>';
  Object.keys(all).forEach(name=>{
    const o=document.createElement('option');
    o.value=name; o.textContent=name;
    sel.appendChild(o);
  });
}
function applyTemplate(t){
  clearServices();
  (t.services||[]).forEach(cfg=>addService(cfg));
  $('#token').value=t.token||'';
  $('#cookie').value=t.cookie||'';
  $('#idType').value=t.idType||'vkn';
  $('#idColName').value=t.idColName||'Vergi No';
  $('#idPath').value=t.idPath||'';
  if(typeof t.delayBase==='number') $('#delayMs').value = String(t.delayBase);
  if(typeof t.autoDelay==='boolean') $('#autoDelay').checked = t.autoDelay;
  if(typeof t.previewCount==='number') $('#previewCount').value = String(t.previewCount);
}

$('#btnSaveTpl').onclick=()=>{
  const name=prompt('Genel ÅŸablon adÄ± girin:'); if(!name) return;
  const all=JSON.parse(localStorage.getItem(TPL_KEY)||'{}');
  all[name]=currentTemplateObject();
  localStorage.setItem(TPL_KEY,JSON.stringify(all));
  loadTemplates();
  alert('Genel ÅŸablon kaydedildi âœ…');
};
$('#selTpl').onchange=()=>{
  const name=$('#selTpl').value; if(!name) return;
  const all=JSON.parse(localStorage.getItem(TPL_KEY)||'{}');
  const t=all[name]; if(!t) return;
  applyTemplate(t);
  renderFieldSelection();
  $('#excelBox').textContent='â€” AlanlarÄ± seÃ§tikten sonra burada ayar yapabilirsin â€”';
  rowsOut=[]; paintRows();
  $('#stat').textContent=`"${name}" genel ÅŸablonu yÃ¼klendi. Yeniden Ã¶n izleme alabilirsin.`;
};
$('#btnDelTpl').onclick=()=>{
  const name=$('#selTpl').value; if(!name) return alert('Silmek iÃ§in bir genel ÅŸablon seÃ§.');
  if(!confirm(`"${name}" genel ÅŸablonunu silmek istiyor musun?`)) return;
  const all=JSON.parse(localStorage.getItem(TPL_KEY)||'{}');
  delete all[name];
  localStorage.setItem(TPL_KEY,JSON.stringify(all));
  loadTemplates();
  alert('Genel ÅŸablon silindi ğŸ—‘ï¸');
};
$('#btnExportTpl').onclick=()=>{
  const allStr=localStorage.getItem(TPL_KEY)||'{}';
  const blob=new Blob([allStr],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='GibSorgu_sablonlar.json';
  document.body.appendChild(a);a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);
};
$('#btnImportTpl').onclick=()=>$('#tplImport').click();
$('#tplImport').onchange=e=>{
  const file=e.target.files[0]; if(!file) return;
  const fr=new FileReader();
  fr.onload=()=>{
    try{
      const obj=JSON.parse(fr.result);
      localStorage.setItem(TPL_KEY,JSON.stringify(obj));
      loadTemplates();
      alert('Genel ÅŸablonlar iÃ§e aktarÄ±ldÄ± âœ…');
    }catch{
      alert('GeÃ§ersiz JSON dosyasÄ±.');
    }
  };
  fr.readAsText(file);
};

/* SERVÄ°S ÅABLON SÄ°STEMÄ° */
function loadServiceTemplates(){
  const all=JSON.parse(localStorage.getItem(SVC_TPL_KEY)||'{}');
  const sel=$('#selSvcTpl');
  sel.innerHTML='<option value="">Servis ÅŸablonu...</option>';
  Object.keys(all).forEach(name=>{
    const o=document.createElement('option');
    o.value=name; o.textContent=name;
    sel.appendChild(o);
  });
}
function serviceTemplateFromSvc(svc){
  const extras={};
  (svc.extraDefs||[]).forEach(d=>{
    extras[d.key]=d.input.value;
  });
  return{
    name:svc.nameEl.value,
    dispatch:svc.dispatchEl.value,
    cmd:svc.cmdEl.value,
    arrayPath:svc.arrayPathEl.value,
    tpl:svc.tplEl.value,
    multiMode:svc.multiEl.value,
    archive: svc.archiveEl ? svc.archiveEl.checked : false,
    extras
  };
}
function applyServiceTemplateToSvc(t,svc){
  svc.nameEl.value = t.name || svc.nameEl.value;
  svc.dispatchEl.value = t.dispatch || '';
  svc.cmdEl.value = t.cmd || '';
  svc.arrayPathEl.value = t.arrayPath || '';
  svc.tplEl.value = t.tpl || '';
  svc.multiEl.value = t.multiMode || 'first';
  rebuildExtraFields(svc);
  if(t.extras){
    svc.extraDefs.forEach(d=>{
      if(t.extras[d.key] !== undefined){
        d.input.value = t.extras[d.key];
      }
    });
  }
  if(svc.archiveEl){
    svc.archiveEl.checked = !!t.archive;
  }
  if(activeService===svc) setActiveServiceLabel(svc);
}

$('#btnSaveSvcTpl').onclick=()=>{
  if(!activeService){alert('Ã–nce bir servis kartÄ±na tÄ±kla (aktif servis).');return;}
  const name=prompt('Servis ÅŸablon adÄ± girin:'); if(!name) return;
  const all=JSON.parse(localStorage.getItem(SVC_TPL_KEY)||'{}');
  all[name]=serviceTemplateFromSvc(activeService);
  localStorage.setItem(SVC_TPL_KEY,JSON.stringify(all));
  loadServiceTemplates();
  alert('Servis ÅŸablonu kaydedildi âœ…');
};
$('#btnLoadSvcTpl').onclick=()=>{
  if(!activeService){alert('Ã–nce bir servis kartÄ±na tÄ±kla (aktif servis).');return;}
  const name=$('#selSvcTpl').value; if(!name){alert('YÃ¼klemek iÃ§in bir servis ÅŸablonu seÃ§.');return;}
  const all=JSON.parse(localStorage.getItem(SVC_TPL_KEY)||'{}');
  const t=all[name]; if(!t){alert('Åablon bulunamadÄ±.');return;}
  applyServiceTemplateToSvc(t,activeService);
  alert(`"${name}" servis ÅŸablonu aktif servise yÃ¼klendi âœ…`);
};
$('#btnDelSvcTpl').onclick=()=>{
  const name=$('#selSvcTpl').value; if(!name){alert('Silmek iÃ§in bir servis ÅŸablonu seÃ§.');return;}
  if(!confirm(`"${name}" servis ÅŸablonunu silmek istiyor musun?`)) return;
  const all=JSON.parse(localStorage.getItem(SVC_TPL_KEY)||'{}');
  delete all[name];
  localStorage.setItem(SVC_TPL_KEY,JSON.stringify(all));
  loadServiceTemplates();
  alert('Servis ÅŸablonu silindi ğŸ—‘ï¸');
};

/* RUN STATE (Dur-Kaldan Devam) */
function saveRunState(nextIndex){
  const state = {
    ids,
    nextIndex,
    rowsOut,
    headers: currentHeaders,
    template: currentTemplateObject(),
    selectedBySvc: services.map(s=>({
      id:s.id,
      selectedFields:(s.selectedFields||[])
    })),
    dynamicDelay,
    successStreak,
    errorStreak
  };
  localStorage.setItem(RUN_KEY,JSON.stringify(state));
}
function loadRunState(){
  const raw = localStorage.getItem(RUN_KEY);
  if(!raw) return null;
  try{
    return JSON.parse(raw);
  }catch{
    return null;
  }
}

/* === Ã–N Ä°ZLEME: Ä°lk N IDâ€™den alanlarÄ± topluyor, N'i sen yazÄ±yorsun === */
$('#btnInit').onclick = async ()=>{
  rowsOut=[]; paintRows(); $('#btnCSV').disabled=true;
  const token=$('#token').value.trim();
  if(!token){alert('Token zorunlu');return;}

  ids = $('#ids').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(!ids.length){alert('ID listesi boÅŸ');return;}

  const cin=($('#cookie').value||'').trim();
  if(cin && !/JSESSIONID=/.test(document.cookie)){
    try{ document.cookie = cin+'; Path=/'; }catch(e){}
  }

  const enabledSvcs = services.filter(s=>s.base || s.enabledEl.checked);
  if(!enabledSvcs.length){alert('En az bir servis etkin olmalÄ±');return;}

  const common={token,idType:$('#idType').value};

  let n = parseInt($('#previewCount').value,10);
  if(isNaN(n) || n<1) n = 1;
  const maxPreview = Math.min(ids.length, n);
  const baseDelay = parseInt($('#delayMs').value,10) || 0;

  enabledSvcs.forEach(svc=>{ svc._fieldSet = new Set(); });

  for(let i=0;i<maxPreview;i++){
    const pid = ids[i];
    $('#stat').textContent=`Ã–n izleme: ${i+1}/${maxPreview} ID taranÄ±yor...`;
    for(const svc of enabledSvcs){
      try{
        const r = await fetchServiceRecords(pid,common,svc);
        if(r.error || r.empty) continue;
        const firstRec = r.arr[0] || {};
        collectKeys(firstRec,'',2,svc._fieldSet);
      }catch(e){
        // sessiz geÃ§
      }
    }
    if(baseDelay>0) await wait(baseDelay);
  }

  enabledSvcs.forEach(svc=>{
    svc.fields = svc._fieldSet ? [...svc._fieldSet] : [];
  });

  renderFieldSelection();
  $('#stat').textContent=`Alanlar ilk ${maxPreview} IDâ€™den birleÅŸtirilerek Ã§Ä±karÄ±ldÄ±. Servis alanlarÄ±nÄ± seÃ§ip "TÃ¼m Listeyi Ã‡alÄ±ÅŸtÄ±r & JOIN" de.`;
};

/* ANA Ã‡ALIÅTIRMA FONKSÄ°YONU */
async function runFrom(startIndex, useExistingSelection){
  const enabledSvcs = services.filter(s=>s.base || s.enabledEl.checked);
  if(!enabledSvcs.length){alert('En az bir servis etkin olmalÄ±');return;}

  if(!useExistingSelection){
    enabledSvcs.forEach(svc=>svc.selectedFields=[]);
    document.querySelectorAll('.fld:checked').forEach(ch=>{
      const sid = Number(ch.dataset.sid);
      const svc = services.find(s=>s.id===sid);
      if(svc) svc.selectedFields.push(ch.value);
    });
    if(!enabledSvcs.some(s=>s.selectedFields.length)){
      alert('En az bir servisten alan seÃ§melisin.');return;
    }
    rowsOut=[]; paintRows();
  }

  writeHeader();
  $('#btnCSV').disabled=true;
  runStop=false;
  $('#btnStop').disabled=false;
  $('#stat').textContent='Ã‡alÄ±ÅŸÄ±yor...';

  const baseDelay = parseInt($('#delayMs').value,10) || 0;
  const autoOn = $('#autoDelay').checked;

  if(!useExistingSelection){
    dynamicDelay = baseDelay;
    successStreak = 0;
    errorStreak = 0;
  }

  const common={token:$('#token').value.trim(),idType:$('#idType').value};
  const idPath=$('#idPath').value.trim();
  const total=ids.length;

  for(let i=startIndex;i<ids.length;i++){
    if(runStop){
      $('#stat').textContent=`${i}/${total} â€¢ Durduruldu, kaldÄ±ÄŸÄ± yer kaydedildi.`;
      saveRunState(i);
      $('#btnStop').disabled=true;
      $('#btnCSV').disabled=false;
      return;
    }

    const id = ids[i];
    let extraTxt = autoOn ? (`Bekleme: ${dynamicDelay} ms`) : (`Bekleme: ${baseDelay} ms`);
    $('#stat').textContent=`${i+1}/${total} iÅŸleniyor... (${extraTxt})`;
    updateBar(i,total,extraTxt);

    let arrBySvc = new Map();
    let anyOk = false;
    let idHasError = false;

    for(const svc of enabledSvcs){
      try{
        const r = await fetchServiceRecords(id,common,svc);
        if(r.error){
          idHasError = true;
          arrBySvc.set(svc.id,[]);
        }else if(r.empty){
          arrBySvc.set(svc.id,[]);
        }else{
          arrBySvc.set(svc.id,r.arr);
          anyOk = true;
        }
      }catch(e){
        idHasError = true;
        arrBySvc.set(svc.id,[]);
      }
    }

    if(!anyOk){
      rowsOut.push([id,'','âŒ HiÃ§bir servisten kayÄ±t dÃ¶nmedi']);
      paintRows();
      saveRunState(i+1);
      if(autoOn){
        idHasError = true;
        errorStreak++;
        successStreak=0;
        dynamicDelay = Math.min(dynamicDelay + 250, 5000);
      }
      const waitMsNo = autoOn ? dynamicDelay : baseDelay;
      if(waitMsNo>0) await wait(waitMsNo);
      continue;
    }

    // ArÅŸiv mi / GÃ¼ncel mi? (En az bir arÅŸiv-tikli servis kayÄ±t dÃ¶ndÃ¼rdÃ¼yse "ArÅŸiv")
    let isArchive = false;
    for(const svc of enabledSvcs){
      if(!svc.archiveEl || !svc.archiveEl.checked) continue;
      const arr = arrBySvc.get(svc.id)||[];
      if(arr.length>0){
        isArchive = true;
        break;
      }
    }

    let keyVal=id;
    if(idPath){
      outer: for(const svc of enabledSvcs){
        const arr = arrBySvc.get(svc.id)||[];
        const rec0 = arr[0]||{};
        const v = get(rec0,idPath);
        if(v!=='' && v!=null){ keyVal=v; break outer; }
      }
    }

    let maxRows = 1;
    enabledSvcs.forEach(svc=>{
      const arr = arrBySvc.get(svc.id)||[];
      const mode = svc.multiEl.value||'first';
      if(mode==='all'){
        if(arr.length>maxRows) maxRows = arr.length;
      }
    });

    for(let k=0;k<maxRows;k++){
      const row=[keyVal, isArchive?'ArÅŸiv':'GÃ¼ncel'];
      for(const svc of enabledSvcs){
        const arr = arrBySvc.get(svc.id)||[];
        const mode = svc.multiEl.value||'first';
        let rec;
        if(mode==='all'){
          rec = arr[k] || {};
        }else{
          rec = arr[0] || {};
        }
        (svc.selectedFields||[]).forEach(f=>{
          row.push(get(rec,f));
        });
      }
      rowsOut.push(row);
    }

    paintRows();

    if(autoOn){
      if(idHasError){
        errorStreak++;
        successStreak=0;
        dynamicDelay = Math.min(dynamicDelay + 250, 5000);
      }else{
        successStreak++;
        errorStreak=0;
        if(successStreak>=5){
          dynamicDelay = Math.max(dynamicDelay - 100, baseDelay);
          successStreak = 0;
        }
      }
    }

    saveRunState(i+1);

    const waitMs = autoOn ? dynamicDelay : baseDelay;
    if(waitMs>0) await wait(waitMs);
  }

  updateBar(total,total, autoOn ? (`Bekleme: ${dynamicDelay} ms`) : (`Bekleme: ${baseDelay} ms`));
  $('#stat').textContent+=' â€¢ Bitti';
  $('#barText').textContent='TamamlandÄ±';
  $('#btnStop').disabled=true;
  $('#btnCSV').disabled=false;
}

/* RUN / STOP / RESUME BUTONLARI */
$('#btnRun').onclick = async ()=>{
  const token=$('#token').value.trim();
  if(!token){alert('Token zorunlu');return;}

  ids = $('#ids').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(!ids.length){alert('ID listesi boÅŸ');return;}

  runFrom(0,false);
};
$('#btnStop').onclick = ()=>{ runStop = true; };
$('#btnResume').onclick = async ()=>{
  const state = loadRunState();
  if(!state){
    alert('KayÄ±tlÄ± yarÄ±m kalmÄ±ÅŸ bir sorgu bulunamadÄ±.');return;
  }
  applyTemplate(state.template);
  loadTemplates();
  loadServiceTemplates();
  ids = state.ids;
  rowsOut = state.rowsOut || [];
  currentHeaders = state.headers || [];
  paintRows();
  renderFieldSelection();
  (state.selectedBySvc||[]).forEach(ss=>{
    const svc = services.find(s=>s.id===ss.id);
    if(!svc) return;
    svc.selectedFields = ss.selectedFields||[];
  });
  document.querySelectorAll('.fld').forEach(ch=>{
    const sid = Number(ch.dataset.sid);
    const svc = services.find(s=>s.id===sid);
    if(!svc) return;
    if(svc.selectedFields.includes(ch.value)){
      ch.checked = true;
    }
  });
  if(currentHeaders.length){
    $('#thead').innerHTML='<tr>'+currentHeaders.map(h=>'<th>'+h+'</th>').join('')+'</tr>';
    renderExcelBox(currentHeaders);
  }
  dynamicDelay = state.dynamicDelay || (parseInt($('#delayMs').value,10) || 0);
  successStreak = state.successStreak || 0;
  errorStreak = state.errorStreak || 0;

  const start = state.nextIndex||0;
  if(start>=ids.length){
    $('#stat').textContent='KayÄ±tlÄ± sorgu zaten tamamlanmÄ±ÅŸ.';
    return;
  }
  $('#stat').textContent=`KayÄ±tlÄ± sorgu yÃ¼klendi. ${start+1}. IDâ€™den devam ediliyor.`;
  runFrom(start,true);
};

/* CSV */
$('#btnCSV').onclick = ()=>{
  if(!rowsOut.length){alert('Veri yok');return;}

  const cfgObj = getColumnConfig();
  const cfgArr = Object.values(cfgObj)
    .filter(c=>c.include)
    .sort((a,b)=>a.order - b.order);

  if(!cfgArr.length){
    alert('HiÃ§ sÃ¼tun seÃ§ilmemiÅŸ (tÃ¼m "Dahil et" kutularÄ± boÅŸ).');return;
  }

  const outRows = [];
  outRows.push(cfgArr.map(c=>c.label));

  rowsOut.forEach(row=>{
    const newRow = cfgArr.map(c=>{
      let val = row[c.index];
      const t = c.type || 'auto';

      if(t==='text'){
        return "'"+String(val??'');
      }
      if(t==='number'){
        const n=Number(String(val).replace(/\./g,'').replace(',','.'));
        return isNaN(n) ? val : n;
      }
      if(t==='date'){
        const d=new Date(val);
        return isNaN(d.getTime()) ? val : d.toISOString().slice(0,10);
      }
      return val;
    });
    outRows.push(newRow);
  });

  const blob=new Blob(['\ufeff'+outRows.map(csvRow).join('\n')],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='GibSorgu_sonuclar.csv';
  document.body.appendChild(a);a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);
};

/* Servis ekle butonu */
$('#btnAddService').onclick=()=>{
  const exampleTpl = '{"mukVkn":"[ID]","durum":"[DURUM]"}';
  addService({base:false,tpl:exampleTpl,multiMode:'all',archive:true});
};

/* BaÅŸlangÄ±Ã§ta iki servis tanÄ±mÄ± + ÅŸablon listeleri */
initDefaultServices();
loadTemplates();
loadServiceTemplates();

/* Alan arama kutusu dinleyicisi */
const fieldSearch = $('#fieldSearch');
if(fieldSearch){
  fieldSearch.addEventListener('input', applyFieldFilter);
}
</script>
</body>
</html>